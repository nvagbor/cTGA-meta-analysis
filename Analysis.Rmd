---
title: "Meta-analysis - Transposition of great arteries"
author: "Valirie N. Agbor"
date: "`r Sys.Date()`"
output: html_document
---

# Work flow
- Load required packages, functions and data 
- Data maipulation
- Perform meta-analysis and run diagnostics 
- Make forest plot for main analysis
- Subgroup analyses
- Small study effect and publication bias 
- Sensitivity analysis, excluding small studies 

# Setting up
## Load libraries and functions
```{r setup, include=FALSE}

rm(list = ls())

pacman::p_load(
  tidyverse, readxl,janitor,purrr,
  meta, metafor, 
  Jasper, 
  gridExtra, ggplotify, ggpubr, ggplot2
)

# Set working directory
knitr::opts_knit$set(
  root.dir = "C:/Users/Valirie N. Agbor/OneDrive/Ongoing projects/ccTGA Meta-analysis and Systematic Review")


knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

```{css, echo = FALSE}
.table tr:nth-child(even) { background; #eee; }
```

##  Load custom functions --

```{r}
## Function takes a dataframe containing results by categories of a group variable
## Without variable label 
## Adds the variable label above the variable categories
## The data must containing a column of variable to be used as group heading and 
## a column containing the names of group levels 

## Extra_space argument adds an extra space with missing value above the inserted headers

## This is important for producing a table for reporting 
## Or formating data for producing forest plot using Jasper 


## Dependencies: Tidyverse, purrr

add_table_header <- function(data, 
                              group_var,
                              group_level_var, 
                              extra_space=FALSE) 
  {
  
  # Get unique levels of group heading 
  group_headers <- pull(data, {{group_var}}) %>% unique(.)
  
  # Add spaces above group names and insert group headings
  if(extra_space==TRUE) 
    {
    tab_df <- data %>% 
      # Stabilise order of group headings before grouping 
      dplyr::mutate("{{group_var}}":=factor({{group_var}}, levels=group_headers)) %>% 
      dplyr::group_by({{group_var}}) %>% dplyr::group_split() %>% 
      purrr::map2_dfr(
        .y = {{group_headers}},
        ~add_row(.x, .before=1, "{{group_level_var}}":=.y) %>% 
          add_row(.before=1) 
        ) %>% 
      select(-{{group_var}})
   
   return(tab_df)
 
  }
  
  tab_df <- data %>% 
    # Stabilise order of group headings before grouping 
    dplyr::mutate("{{group_var}}":=factor({{group_var}}, levels=group_headers)) %>% 
    dplyr::group_by({{group_var}}) %>% dplyr::group_split() %>% 
    purrr::map2_dfr(.y={{group_headers}},  ~dplyr::add_row(.x, .before = 1, "{{group_level_var}}":=c(.y))) %>% 
    # Bind dataframe 
    select(-{{group_var}})
  
  return(tab_df)
  
}


#function to extract digits in parenthesis -------------------
str_digit_par_extract <- function(x){
  
  str_extract(str_extract(x, pattern="\\(([0-9]*)\\)"), pattern="\\d+")
  
}
```


# Import and clean data --

```{r}

datasets <- map(
  .x=1:2,
  ~read_excel("outcome_data.xlsx", sheet=.x) %>% 
    clean_names() %>% 
    mutate(
      author_year=paste0(study, ", ", year_of_publication),
      surgery=factor(surgery, levels=c("Anatomic", "Physiologic", "DSO", "Rastelli")),
      across(.cols=starts_with("n_"), as.numeric)) %>% 
    select(author_year, surgery, sample, all_of(starts_with("n_"))))

```


# Run meta-analysis --

Fit a random-effect meta-analysis using a DL estimator. 
Stabilise the variance of study-specific estimates using the Freeman-Tukey double-arcsine transformation 


## Fit model

```{r Metafor - Summary prop}

# Transform proportions
# Loop (1) datasets | (2) type of surgery
time_points  <- c("n_inhospital_30d", "n_1y", "n_5y", "n_10y")
surgery_type <- levels(datasets[[1]]$surgery)
endpoints    <- c("mortality", "reintervention")

pes.da <- list()
pes <- list()
summary_forest <- list()

for (jj in seq_along(datasets)) {
  for(kk in surgery_type){
    for (ll in time_points) {
      
      # Remove missing data
      data_temp <- 
        datasets[[jj]] %>% 
        filter(surgery==kk) %>% 
        select(all_of(c("author_year", "surgery", "sample", ll))) %>% 
        rename(n=all_of(ll)) %>% #Rename the event column to ease manipulation
        na.omit(.)
      
      # Compute and stabilise the variances using Freeman-Turkey double arcsine transformation
      pes.da[[endpoints[jj]]][[kk]][[ll]] <- metafor::escalc(
           xi      = n,
           ni      = sample,
           measure = "PFT", 
           data    = data_temp, 
           add     = 0) %>% 
        
      # Run REMA using DL estimator
        metafor::rma(
           yi, 
           vi, 
           data     = ., 
           method   = "DL", 
           weighted = TRUE, 
           slab     = data_temp[["author_year"]])
      
      # Backtransform proportions
      pes[[endpoints[jj]]][[kk]][[ll]] <- predict(
           pes.da[[endpoints[jj]]][[kk]][[ll]],
           transf = transf.ipft.hm,
           targ   = list(ni = data_temp[["sample"]]))
      
      # Extract relevant data to use for plotting
      summary_forest[[endpoints[jj]]][[kk]][[ll]] <- 
        as.data.frame(pes[[endpoints[jj]]][[kk]][[ll]]) %>% 
        transmute(
          Endpoint=endpoints[jj], 
          surgery=kk, 
          time=case_when(ll=="n_inhospital_30d"~"In-hospital", 
                         ll=="n_1y"~"1 year", 
                         ll=="n_5y"~"5 years", 
                         TRUE~"10 years"),
          incidence=pred*100, 
          LCI=ci.lb*100, 
          UCI=ci.ub*100,
          I2=paste0(round(pes.da[[endpoints[jj]]][[kk]][[ll]][["I2"]], 1), "%"),
          tau2=round(pes.da[[endpoints[jj]]][[kk]][[ll]][["tau2"]], 4), 
          phet=pes.da[[endpoints[jj]]][[kk]][[ll]][["QEp"]], 
          phet=case_when(
            phet>=0.0001~format(round(phet, 4), nsmall=4, scientific=FALSE), 
            TRUE~format(phet, digits=3, nsmall=2, scientific=TRUE)),
          n=sum(data_temp$n), 
          N=sum(data_temp[["sample"]]),
          n_studies=nrow(data_temp)
        )
      }
    
    }

  }

knitr::opts_chunk$set(echo = FALSE)

```


## Identify outliers and influential studies 

### Baujat plot 
```{r Baujat plot}

for (jj in seq_along(datasets)) {
  for(kk in surgery_type){
    for (ll in time_points) {
        baujat_list <- baujat(pes.da[[endpoints[jj]]][[kk]][[ll]], symbol = "slab")
    }}}

```

### Influence analysis 
```{r Influential studies}
for (jj in seq_along(datasets)) {
  for(kk in surgery_type){
    for (ll in time_points) {
        plot(influence(pes.da[[endpoints[jj]]][[kk]][[ll]]))
    }}}

```

### Leave-1-out analysis 

L1O analysis shows to significant influence of a single study on the pooled summary estimate. 
Hence, no study was dropped. 

```{r leave-1-out}

for (jj in seq_along(datasets)){
  for(kk in surgery_type){
    for (ll in time_points){
      l1o <- metafor::leave1out(pes.da[[endpoints[jj]]][[kk]][[ll]])
      yi <- l1o$estimate
      vi <- l1o$se^2
      
      data_temp <- 
        datasets[[jj]] %>% 
        filter(surgery==kk) %>% 
        select(all_of(c("author_year", "surgery", "sample", ll))) %>% 
        na.omit(.)
      
      # Plot L1O analysis results
      metafor::forest(
             yi,
             vi,
             transf = transf.ipft.hm,
             targ   = list(ni = data_temp$sample),
             slab   = data_temp$author_year,
             xlab   = "Summary proportions leaving out each study",
             refline= pes[[endpoints[jj]]][[kk]][[ll]]$pred,
             digits = 6)
    }}}

```

## Forest plot -- 

Once you are satisfied that there are no influential studies, fit the meta-analysis and make forest plots

```{r forestplot, fig.height = 11, fig.width = 11}

MA_random <- list()

for (jj in seq_along(datasets)){
  for(kk in surgery_type){
    for (ll in time_points){
      
      data_temp <- 
        datasets[[jj]] %>% 
        filter(surgery==kk) %>% 
        select(all_of(c("author_year", "surgery", "sample", ll))) %>% 
        na.omit(.)
      
      MA_random[[endpoints[jj]]][[kk]][[ll]] <-  meta::metaprop(
                  data        = data_temp, 
                  event       = data_temp[[ll]], 
                  n           = sample,
                  studlab     = author_year,  
                  sm          = "PFT", 
                  method.ci   = "CP", 
                  level       = 0.95, 
                  method.tau  = "DL", 
                  pscale      = 100,
                  digits.pval = 4, 
                  prediction  = TRUE, 
                  level.ma    = 0.95, 
                  random      = TRUE, 
                  fixed       = FALSE)
      
    }
  }
}


# Make forestplot ----
for (jj in seq_along(datasets)){
  for(kk in surgery_type){
    for (ll in time_points){
      
      # Get length of dataset
      n_row <- 
        datasets[[jj]] %>% 
        filter(surgery==kk) %>% 
        select(all_of(c("author_year", "surgery", "sample", ll))) %>% 
        na.omit(.) %>% 
        nrow(.)
      
      png(paste0(c("Mortality/", "Reintervention/")[jj], endpoints[jj],"_", kk, "_", ll, ".png"), 
      units     = "in",
      width     = 10, 
      height    = ifelse(n_row <20, 7, 14), # Programmatically set page height
      pointsize = 15,  
      res       = 300, 
      bg        = "white") 
      
      
      #Forest plot
      meta::forest(MA_random[[endpoints[jj]]][[kk]][[ll]],
         xlim        = c(-5, 60), 
         pscale      = 100,
         rightcols   = c("effect", "ci","w.random"),
         rightlabs   = c("Incidence",  "95% CI","    Weight(%)"),
         leftcols    = c("studlab", "event", "n"), 
         leftlabs    = c("Study", "          Cases", "  Sample"),
         xlab        = "Incidence (%)",
         xlab.pos    = 30,
         ff.xlab     = "bold", 
         fs.axis     = 11,
         sortvar     = author_year,
         fs.lr       = 10,
         fs.xlab     = 13,
         fs.study    = 10.3,
         fs.study.lables=10.3,
         fs.heading=11,
         fs.random = 10.3, 
         fs.predict = 10.3,
         fs.predict.labels = 10.3,
         fs.hetstat=10,
         squaresize = 0.45, 
         col.square="gray", 
         col.square.lines="gray",
         col.diamond="black", 
         col.diamond.lines="black",
         comb.fixed=FALSE,
         comb.random=FALSE,
         lty.fixed=0,
         lty.random=2, 
         type.study="square",
         type.random="diamond",
         #ff.fixed="bold.italic",
         ff.random="bold",
         hetlab = "Heterogeneity:",
         spacing = 1,
         smlab="",
         plotwidth = "6cm",
         pooled.events = TRUE,
         print.Q=FALSE,
         print.tau2.ci = FALSE,
         print.pval.Q=TRUE,
         print.I2=TRUE,
         print.tau2=TRUE,
         prediction = TRUE,
         col.by="grey",
         digits.addcols.right = 1,
         digits.I2 = 1, 
         digits.pval.Q = 4, 
         digits.weight = 1, 
         digits.tau2 = 4,
         digits = 1,
         fixed = FALSE)
      
      dev.off()
    }
  }
}


```

## Summary forest plot with Jasper 

### Anatomic versus physiologic 

```{r}

# Get and bind data for anatomic and physio only
merged_forest <- map(
  .x=summary_forest, 
  ~flatten_df(.x) %>% mutate(n_event=paste0(n, "/", N)) %>% 
    filter(!surgery%in%c("DSO", "Rastelli"))) 

merged_forest <- map(
  .x = merged_forest, 
  ~add_table_header(
    data=.x, 
    group_var=surgery, 
    group_level_var=time, 
    extra_space=FALSE) %>%
    select(-Endpoint) %>%
    dplyr::mutate(
      IsDiamond=ifelse(!is.na(incidence), 0, incidence), 
      FillColour=ifelse(!is.na(incidence)==TRUE, 1, incidence)) %>% 
    rename(Heading=time) %>% 
    as.data.frame(.)
  )

# set up an object that stores the forest and associated metadata
forest <- map2(
    .x=merged_forest, 
    .y=seq_along(merged_forest), 
    ~FormatForest(
      rawdata=rename(.x,
                     !!paste0("IsDiamond", .y):=IsDiamond,
                     !!paste0("FillColour", .y):=FillColour),
    forest.n    = .y,
    EstimateCol = "incidence",
    LCICol      = "LCI",
    UCICol      = "UCI",
    logData     = FALSE,
    getBlanks   = TRUE)
  )


blank.rows  <- forest[[1]]$blank.rows 

# Format headings to incorporate expressions ------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(merged_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- c("n_studies", "n_event", "I2", "tau2", "phet")
other.cols.labels <- c("Studies", "n/N", "I\U00B2", "Tau\U00B2", "P(Het)")

# find column headings
print.headings <- parseColHeadings(merged_forest[[1]]$ColHeadings, rd=merged_forest[[1]])


# Make forest plot --

type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage=2,
        type            = type, 
        filestem        = "Main summary plots/Figure 1 Summary forest plot main analysis", 
        page_dpi        = 300,
        page_pointsize  = 15,
        page_height     = 9.5,
        page_width      = 9.5,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.06, 
        footerspace     = 0.01, 
        footer.cex      = 1.6, 
        footer          = "\nn = Number of events; N = Sample size; Het = heterogeneity
        \n " 
        )


# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 3.14537797266251, 1))

mainfont <- 1.1
# blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

# Make forest plot -- 
n_forest   <- length(forest) 

# Plot setting --
spacing    <- 0
plot.width <- 25

# plot labels -- 
xaxmin=33
xaxmax=xaxmin + plot.width

#x position for other headings 
other.column.xpos <- c(xaxmin-16, xaxmin-8, xaxmax+16, xaxmax+23, xaxmax+30) 
outcomeLabs <- c("A. Mortality", "B. Reintervention")

# Draw forest plot -- 
locs <- list()

for (cc in seq_along(forest)) {

  blankPlot(c(0,100),c(0,100), mainfont)
  
  locs[[cc]] <- 
    ForestBasic(
        forest[[cc]],
      	LogScale          = FALSE,
      	ExponentiateDataOnPlot=FALSE,
      	xaxmin            = xaxmin,
      	xaxmax            = xaxmax,
      	xlim              = c(-5, 45), 
      	xticks            = seq(0, 40, 10),
        xticks.ticklength = 0.25,
      	xlab              = c("", "Incidence (%)")[cc],
      	NLabel            = FALSE,
      	mainfont          = 1,
      	ValueLabels       = TRUE,
      	ValueLabelsHeader = "Incidence (95% CI)\n",
      	ValueDigits       = 1,
      	lwd               = 1,
      	CISecond          = TRUE,
      	separator         = " - ",
      	spacing           = spacing,
      	pointGroupsFactor = 0.9,
      	verbose           = FALSE,
      	boxsizeoverride   = TRUE,
      	boxparm.stderr    = 1)

# add titles above forest (may be left empty, change labels="" to what you will)

# Draw segment -- 
segments(
  x0  = 0,
  x1  = 94,
  y0  = 98.4,
  y1  = 98.4,
  lwd = 1.3,
  xpd = FALSE)
 
#Outcome label --
text(x      = 0, 
     y      = 117, 
     labels = outcomeLabs[cc], 
     col    = "black",
     adj    = c(0,0), 
     font   = 2, 
     cex    = 1.1)

# left hand column of labels
text(x=0, y=100, labels="Endpoints\n", adj=c(0,0), font=2, cex=1)
text(x=0, y=locs[[cc]]$YLocs, adj=0, cex=1, font=ifelse(forest[[cc]]$IsDiamond, 2,1), labels=left.labels[-blank.rows])
text(x=0, y=locs[[cc]]$BlankLocs, adj=0, font=2, cex=1, labels=left.labels[blank.rows])

# adding other columns for HF and PHD ---

for (jj in seq_along(other.cols)) {
  
  text(x=other.column.xpos[jj], y=105.5, adj=c(0,0), font=2, cex=1, labels=convertUnicode(other.cols.labels[jj]))
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$YLocs,
       font   = ifelse(forest[[cc]]$IsDiamond, 2, 1),
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(merged_forest[[cc]][,other.cols[jj]]))[-blank.rows])
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$BlankLocs,
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(merged_forest[[cc]][,other.cols[jj]]))[blank.rows])
  }

}
  
# stop writing to file
closeFile(type)

```

### DSO versus Rastelli 

```{r}

# Get and bind data for anatomic and physio only
dso_rastelli <- map(
  .x=summary_forest, 
  ~flatten_df(.x) %>% mutate(n_event=paste0(n, "/", N)) %>% 
    filter(surgery%in%c("DSO", "Rastelli"))) 

dso_rastelli <- map(
  .x = dso_rastelli, 
  ~add_table_header(
    data=.x, 
    group_var=surgery, 
    group_level_var=time, 
    extra_space=FALSE) %>%
    select(-Endpoint) %>%
    dplyr::mutate(
      IsDiamond=ifelse(!is.na(incidence), 0, incidence), 
      FillColour=ifelse(!is.na(incidence)==TRUE, 1, incidence)) %>% 
    rename(Heading=time) %>% 
    as.data.frame(.)
  )

# set up an object that stores the forest and associated metadata
forest <- map2(
    .x=dso_rastelli, 
    .y=seq_along(dso_rastelli), 
    ~FormatForest(
      rawdata=rename(.x,
                     !!paste0("IsDiamond", .y):=IsDiamond,
                     !!paste0("FillColour", .y):=FillColour),
    forest.n    = .y,
    EstimateCol = "incidence",
    LCICol      = "LCI",
    UCICol      = "UCI",
    logData     = FALSE,
    getBlanks   = TRUE)
  )


blank.rows  <- forest[[1]]$blank.rows 

# Format headings to incorporate expressions ------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(dso_rastelli[[1]]$Heading))

# what other columns should be plotted
other.cols  <- c("n_studies", "n_event", "I2", "tau2", "phet")
other.cols.labels <- c("Studies", "n/N", "I\U00B2", "Tau\U00B2", "P(Het)")

# find column headings
print.headings <- parseColHeadings(dso_rastelli[[1]]$ColHeadings, rd=dso_rastelli[[1]])


# Make forest plot --

type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage=2,
        type            = type, 
        filestem        = "Main summary plots/Figure - DSO versus Rastelli", 
        page_dpi        = 300,
        page_pointsize  = 15,
        page_height     = 9.5,
        page_width      = 9.5,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.06, 
        footerspace     = 0.01, 
        footer.cex      = 1.6, 
        footer          = "\nn = Number of events; N = Sample size; Het = heterogeneity
        \n " 
        )


# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 3.14537797266251, 1))

mainfont <- 1.1
# blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

# Make forest plot -- 
n_forest   <- length(forest) 

# Plot setting --
spacing    <- 0
plot.width <- 25

# plot labels -- 
xaxmin=33
xaxmax=xaxmin + plot.width

#x position for other headings 
other.column.xpos <- c(xaxmin-16, xaxmin-8, xaxmax+16, xaxmax+23, xaxmax+30) 
outcomeLabs <- c("A. Mortality", "B. Reintervention")

# Draw forest plot -- 
locs <- list()

for (cc in seq_along(forest)) {

  blankPlot(c(0,100),c(0,100), mainfont)
  
  locs[[cc]] <- 
    ForestBasic(
        forest[[cc]],
      	LogScale          = FALSE,
      	ExponentiateDataOnPlot=FALSE,
      	xaxmin            = xaxmin,
      	xaxmax            = xaxmax,
      	xlim              = c(-5, 45), 
      	xticks            = seq(0, 40, 10),
        xticks.ticklength = 0.25,
      	xlab              = c("", "Incidence (%)")[cc],
      	NLabel            = FALSE,
      	mainfont          = 1,
      	ValueLabels       = TRUE,
      	ValueLabelsHeader = "Incidence (95% CI)\n",
      	ValueDigits       = 1,
      	lwd               = 1,
      	CISecond          = TRUE,
      	separator         = " - ",
      	spacing           = spacing,
      	pointGroupsFactor = 0.9,
      	verbose           = FALSE,
      	boxsizeoverride   = TRUE,
      	boxparm.stderr    = 1)

# add titles above forest (may be left empty, change labels="" to what you will)

# Draw segment -- 
segments(
  x0  = 0,
  x1  = 94,
  y0  = 98.4,
  y1  = 98.4,
  lwd = 1.3,
  xpd = FALSE)
 
#Outcome label --
text(x      = 0, 
     y      = 117, 
     labels = outcomeLabs[cc], 
     col    = "black",
     adj    = c(0,0), 
     font   = 2, 
     cex    = 1.1)

# left hand column of labels
text(x=0, y=100, labels="Endpoints\n", adj=c(0,0), font=2, cex=1)
text(x=0, y=locs[[cc]]$YLocs, adj=0, cex=1, font=ifelse(forest[[cc]]$IsDiamond, 2,1), labels=left.labels[-blank.rows])
text(x=0, y=locs[[cc]]$BlankLocs, adj=0, font=2, cex=1, labels=left.labels[blank.rows])

# adding other columns for HF and PHD ---

for (jj in seq_along(other.cols)) {
  
  text(x=other.column.xpos[jj], y=105.5, adj=c(0,0), font=2, cex=1, labels=convertUnicode(other.cols.labels[jj]))
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$YLocs,
       font   = ifelse(forest[[cc]]$IsDiamond, 2, 1),
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(dso_rastelli[[cc]][,other.cols[jj]]))[-blank.rows])
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$BlankLocs,
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(dso_rastelli[[cc]][,other.cols[jj]]))[blank.rows])
  }

}
  
# stop writing to file
closeFile(type)

```


# Subgroup --

```{r subgroup}

# Import and clean variables 
baseline <- read_excel("Baseline data revised.xlsx") %>%
    clean_names() %>% 
    mutate_at(
      c("pm", "preoperative_pab", "moderate_tr"), 
      ~case_when(.x=="NS"~NA_character_, TRUE~.x) %>% str_digit_par_extract(.) %>% as.numeric(.)) %>%  
    mutate(
      median_age_y= map_chr(.x=str_split(median_age_y, " "), ~.x[1]) %>% as.numeric(.), 
      unsd_region_subgroup=case_when(
        country%in%c("USA", "Germany", "France", "UK", "Netherlands")~"North America and Europe", 
        TRUE~"Asia and Oceania"))
  
## Categorise variables for subgroup analysis
baseline <- mutate(
    baseline, 
    age_subgroup=factor(case_when(median_age_y<5~"<5", TRUE~"≥5")), 
    pm_subgroup=factor(case_when(
      pm<20~"<20", 
      pm>=20~"≥20", 
      TRUE~NA_character_)),  
    moderate_tr_subgroup=factor(case_when(
      moderate_tr<20~"<20", 
      moderate_tr>=20~"≥20", 
      TRUE~NA_character_)), 
    pab_subgroup=factor(case_when(
      preoperative_pab<30~"<30", 
      preoperative_pab>=30~"≥30", 
      TRUE~NA_character_))) %>% 
  select(author_year, surgery,  contains("_subgroup"))

# Join baseline data to main dataset  
data_subgroup <- map(
  .x=datasets, 
  ~inner_join(
    filter(.x, !surgery%in%c("DSO", "Rastelli")), 
    baseline ,  
    by=c("author_year", "surgery"))) %>% setNames(c("Mortality", "Reintervention"))

# List of labels for subgroup analysis
subgroup_var_names <- select(baseline, contains("_subgroup")) %>% names(.) %>% sort(.)

subgroup_var_labs <- list(
  "Anatomic"=c("Median age (years)", 
               "Moderate or severe TR (%)", 
               "Preoperative PAB (%)", 
               "Pacemaker (%)", 
               "UNSD region"), 
  
  "Physiologic"=c("Median age (years)", 
                  "Moderate or severe TR (%)", 
                  "Pacemaker (%)", 
                  "UNSD region") 
)

subgroup_list <- list(
  "Mortality"=list(
    "Anatomic"=subgroup_var_names, 
    "Physiologic"=subgroup_var_names[-which(subgroup_var_names=="pab_subgroup")]), 
  
  "Reintervention"=list(
    "Anatomic"=subgroup_var_names,
    "Physiologic"=subgroup_var_names[-which(subgroup_var_names=="pab_subgroup")])
)

Endpoints <- str_to_sentence(endpoints)

# Run subgroup analysis ---
result_subgroup <- list()

for(jj in seq_along(datasets)){
  for(kk in names(subgroup_var_labs)){
    for(ll in time_points){
      for(ss in seq_along(subgroup_list[[jj]][[kk]])){
        
        subgroup.var.temp <- subgroup_list[[jj]][[kk]][[ss]]
        subgroup.var.lab.temp <- subgroup_var_labs[[kk]][[ss]]
        
        # Get dataset
        data_temp <- 
          data_subgroup[[jj]] %>% 
          filter(surgery==kk) %>% 
          select(all_of(c("author_year", "surgery", "sample", ll, subgroup.var.temp))) %>% na.omit(.)
      
        result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[subgroup.var.temp]] <- 
          meta::metaprop(
                    data          = data_temp, 
                    data_temp[[ll]], 
                    sample,
                    studlab       = data_temp[["author_year"]],  
                    sm            = "PFT", 
                    method.ci     = "CP", 
                    level         = 0.95, 
                    method.tau    = "DL", 
                    pscale        = 100,
                    digits.pval   = 4, 
                    prediction    = TRUE, 
                    level.ma      = 0.95, 
                    random        = TRUE, 
                    fixed         = FALSE,
                    subgroup      = data_temp[[subgroup.var.temp]], 
                    subgroup.name = subgroup.var.lab.temp) 
        
        get_result_temp <- result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[subgroup.var.temp]]
          
          result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[subgroup.var.temp]] <-
               update(
                  get_result_temp, 
                  byvar=get_result_temp$data[[".subgroup"]], 
                  subgroup.name=subgroup.var.lab.temp)
          }
      
      # Bind results for time 
        if(kk=="Anatomic"){ #
          result_subgroup[[Endpoints[jj]]][[kk]][[ll]] <-
            meta::metabind(
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[1]],
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[2]],
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[3]],
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[4]],
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[5]])
          }else{
              result_subgroup[[Endpoints[jj]]][[kk]][[ll]] <-
                meta::metabind(
                  result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[1]],
                  result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[2]],
                  result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[3]],
                  result_subgroup[[Endpoints[jj]]][[kk]][[ll]][[4]])
              }
          }
      }
  }



# Make summary forest plot for subgroup analysis --
for(jj in seq_along(datasets)){
  for(kk in names(subgroup_var_labs)){
    for(ll in time_points){
      
      png(paste0("Subgroup/", Endpoints[jj], "_", kk, "_", ll,"_SUMMARIZED.png"), 
             units     = "in", 
             width     = 9, 
             height    = 6, 
             pointsize = 11,  
             res       = 300)  
      
      meta::forest(result_subgroup[[Endpoints[jj]]][[kk]][[ll]], 
             spacing     = 1, 
             plot.width  = "6cm",
             xlab        = "\nIncidence (%)",
             xlab.pos    = 20,
             xlim        = c(0, 40),
             rightcols   = c("effect", "ci", "I2"), 
             rightlabs   = c("Incidence", "95% CI", "I\U00B2"),
             leftlabs    = c("Studies (N)", "P(Het)"),
             smlab       = "Random effects",
             colgap      = "4mm",
             squaresize  = 0.5, 
             col.by      = "dark blue", 
             print.subgroup.labels = TRUE)
      
      dev.off()
      
    }}}


```


# Funnel plots and publication bias--
## Anatomic vs physiologic

```{r Funnel plots }

# Extract p-values --
bias_p <- list()
for (jj in seq_along(datasets)){
  for(kk in surgery_type){
    for (ll in time_points){
      
      bias_p[[endpoints[jj]]][[kk]][[ll]] <- metabias(
        MA_random[[endpoints[jj]]][[kk]][[ll]], 
        k.min = 5, method.bias = "linreg")$pval %>% round(., 4) %>% format(nsmall=4L)
    }}}

xlab_list <- list(
  "top"="", 
  "bottom"="Freeman-Tukey double arcsine\ntransformed proportion")

x.pval <- list(
  "top"=list("n_inhospital_30d"=0, "n_1y"=0, "n_5y"=0, "n_10y"=0.18), 
  "bottom"=list("n_inhospital_30d"=0, "n_1y"=0.1, "n_5y"=0.2, "n_10y"=0.3)
  )

Panel.titles <- list(
  "top"=list(
    "n_inhospital_30d"="Anatomic\n\nIn-hospital", 
    "n_1y"="\n\n1 year",
    "n_5y"="\n\n5 year",
    "n_10y"="\n\n10 year"), 
  "bottom"=list(
    "n_inhospital_30d"="Physiologic", 
    "n_1y"="",
    "n_5y"="",
    "n_10y"="")
  )

# Anato vs physio -----------
Surgery <- c("Anatomic", "Physiologic")
 
for (jj in seq_along(endpoints)){
  png(paste0("Funnel plots/Funnel_", endpoints[jj],paste(Surgery, collapse = "+"),".png"),
      units     = "in",
      width     = 11,
      height    = 7,
      res       = 300,
      pointsize = 12)
  par(mfrow=(c(2, 4)))
  for(kk in seq_along(Surgery)){
    for (ll in time_points){
      
      meta:::funnel.meta(MA_random[[endpoints[jj]]][[Surgery[kk] ]][[ll]],
                backtransf = TRUE,
                col     = "navy blue",
                back    = "white",
                xlab    = xlab_list[[kk]])
      
      title(Panel.titles[[kk]][[ll]], cex=1, adj=0)
      
      text(
        x=x.pval[[kk]][[ll]], 
        y=0.01, 
        label=paste0("p(Egger):\n", bias_p[[endpoints[jj]]][[Surgery[kk] ]][[ll]]), 
        cex=0.7, adj=0)
      }
    }
 dev.off()
}


# DSO vs Rastelli --------
## Note: Surgery = Anatomic
Surgery <- c("DSO", "Rastelli")

Panel.titles <- list(
  "DSO"=list(
    "n_inhospital_30d"="DSO\n\nIn-hospital", 
    "n_1y"="\n\n1 year",
    "n_5y"="\n\n5 year",
    "n_10y"="\n\n10 year"), 
  "Rastelli"=list(
    "n_inhospital_30d"="Rastelli", 
    "n_1y"="",
    "n_5y"="",
    "n_10y"="")
  )


for (jj in seq_along(endpoints)){
  png(paste0("Funnel plots/Funnel_", endpoints[jj],paste(Surgery, collapse = "+"),".png"),
      units     = "in",
      width     = 11,
      height    = 7,
      res       = 300,
      pointsize = 12)
  par(mfrow=(c(2, 4)))
  for(kk in seq_along(Surgery)){
    for (ll in time_points){
      
      meta:::funnel.meta(MA_random[[endpoints[jj]]][[Surgery[kk] ]][[ll]],
                backtransf = TRUE,
                col     = "navy blue",
                back    = "white",
                xlab    = xlab_list[[kk]])
      
      title(Panel.titles[[Surgery[kk] ]][[ll]], cex=1, adj=0)
      
      text(
        x=x.pval[[kk]][[ll]], 
        y=0.01, 
        label=paste0("p(Egger):\n", bias_p[[endpoints[jj]]][[Surgery[kk] ]][[ll]]), 
        cex=0.7, adj=0)
      }
    }
 dev.off()
}

```

# Sensitivity analysis --- 
Excluding studies with N<20


```{r Metafor - Summary prop}

# Transform proportions
# Loop (1) datasets | (2) type of surgery
time_points  <- c("n_inhospital_30d", "n_1y", "n_5y", "n_10y")
surgery_type <- levels(datasets[[1]]$surgery)
endpoints    <- c("mortality", "reintervention")

pes.da <- list()
pes <- list()
summary_forest <- list()

for (jj in seq_along(datasets)) {
  for(kk in surgery_type){
    for (ll in time_points) {
      
      # Remove missing data
      data_temp <- 
        datasets[[jj]] %>% 
        filter(surgery==kk, sample>=20) %>% 
        select(all_of(c("author_year", "surgery", "sample", ll))) %>% 
        rename(n=all_of(ll)) %>% #Rename the event column to ease manipulation
        na.omit(.)
      
      # Compute and stabilise the variances using Freeman-Turkey double arcsine transformation
      pes.da[[endpoints[jj]]][[kk]][[ll]] <- metafor::escalc(
           xi      = n,
           ni      = sample,
           measure = "PFT", 
           data    = data_temp, 
           add     = 0) %>% 
        
      # Run REMA using DL estimator
        metafor::rma(
           yi, 
           vi, 
           data     = ., 
           method   = "DL", 
           weighted = TRUE, 
           slab     = data_temp[["author_year"]])
      
      # Backtransform proportions
      pes[[endpoints[jj]]][[kk]][[ll]] <- predict(
           pes.da[[endpoints[jj]]][[kk]][[ll]],
           transf = transf.ipft.hm,
           targ   = list(ni = data_temp[["sample"]]))
      
      # Extract relevant data to use for plotting
      summary_forest[[endpoints[jj]]][[kk]][[ll]] <- 
        as.data.frame(pes[[endpoints[jj]]][[kk]][[ll]]) %>% 
        transmute(
          Endpoint=endpoints[jj], 
          surgery=kk, 
          time=case_when(ll=="n_inhospital_30d"~"In-hospital", 
                         ll=="n_1y"~"1 year", 
                         ll=="n_5y"~"5 years", 
                         TRUE~"10 years"),
          incidence=pred*100, 
          LCI=ci.lb*100, 
          UCI=ci.ub*100,
          I2=paste0(round(pes.da[[endpoints[jj]]][[kk]][[ll]][["I2"]], 1), "%"),
          tau2=round(pes.da[[endpoints[jj]]][[kk]][[ll]][["tau2"]], 4), 
          phet=pes.da[[endpoints[jj]]][[kk]][[ll]][["QEp"]], 
          phet=case_when(
            phet>=0.0001~format(round(phet, 4), nsmall=4, scientific=FALSE), 
            TRUE~format(phet, digits=3, nsmall=2, scientific=TRUE)),
          n=sum(data_temp$n), 
          N=sum(data_temp[["sample"]]),
          n_studies=nrow(data_temp)
        )
      }
    
    }

  }

knitr::opts_chunk$set(echo = FALSE)

```

## Make forest plot 

### Anatomic versus physiologic 

```{r}

# Get and bind data for anatomic and physio only
merged_forest <- map(
  .x=summary_forest, 
  ~flatten_df(.x) %>% mutate(n_event=paste0(n, "/", N)) %>% 
    filter(!surgery%in%c("DSO", "Rastelli"))) 

merged_forest <- map(
  .x = merged_forest, 
  ~add_table_header(
    data=.x, 
    group_var=surgery, 
    group_level_var=time, 
    extra_space=FALSE) %>%
    select(-Endpoint) %>%
    dplyr::mutate(
      IsDiamond=ifelse(!is.na(incidence), 0, incidence), 
      FillColour=ifelse(!is.na(incidence)==TRUE, 1, incidence)) %>% 
    rename(Heading=time) %>% 
    as.data.frame(.)
  )

# set up an object that stores the forest and associated metadata
forest <- map2(
    .x=merged_forest, 
    .y=seq_along(merged_forest), 
    ~FormatForest(
      rawdata=rename(.x,
                     !!paste0("IsDiamond", .y):=IsDiamond,
                     !!paste0("FillColour", .y):=FillColour),
    forest.n    = .y,
    EstimateCol = "incidence",
    LCICol      = "LCI",
    UCICol      = "UCI",
    logData     = FALSE,
    getBlanks   = TRUE)
  )


blank.rows  <- forest[[1]]$blank.rows 

# Format headings to incorporate expressions ------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(merged_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- c("n_studies", "n_event", "I2", "tau2", "phet")
other.cols.labels <- c("Studies", "n/N", "I\U00B2", "Tau\U00B2", "P(Het)")

# find column headings
print.headings <- parseColHeadings(merged_forest[[1]]$ColHeadings, rd=merged_forest[[1]])


# Make forest plot --

type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage=2,
        type            = type, 
        filestem        = "Sensitivity/Summary forest plot main analysis", 
        page_dpi        = 300,
        page_pointsize  = 15,
        page_height     = 9.5,
        page_width      = 9.5,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.06, 
        footerspace     = 0.01, 
        footer.cex      = 1.6, 
        footer          = "\nn = Number of events; N = Sample size; Het = heterogeneity
        \n " 
        )


# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 3.14537797266251, 1))

mainfont <- 1.1
# blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

# Make forest plot -- 
n_forest   <- length(forest) 

# Plot setting --
spacing    <- 0
plot.width <- 25

# plot labels -- 
xaxmin=33
xaxmax=xaxmin + plot.width

#x position for other headings 
other.column.xpos <- c(xaxmin-16, xaxmin-8, xaxmax+16, xaxmax+23, xaxmax+30) 
outcomeLabs <- c("A. Mortality", "B. Reintervention")

# Draw forest plot -- 
locs <- list()

for (cc in seq_along(forest)) {

  blankPlot(c(0,100),c(0,100), mainfont)
  
  locs[[cc]] <- 
    ForestBasic(
        forest[[cc]],
      	LogScale          = FALSE,
      	ExponentiateDataOnPlot=FALSE,
      	xaxmin            = xaxmin,
      	xaxmax            = xaxmax,
      	xlim              = c(-5, 45), 
      	xticks            = seq(0, 40, 10),
        xticks.ticklength = 0.25,
      	xlab              = c("", "Incidence (%)")[cc],
      	NLabel            = FALSE,
      	mainfont          = 1,
      	ValueLabels       = TRUE,
      	ValueLabelsHeader = "Incidence (95% CI)\n",
      	ValueDigits       = 1,
      	lwd               = 1,
      	CISecond          = TRUE,
      	separator         = " - ",
      	spacing           = spacing,
      	pointGroupsFactor = 0.9,
      	verbose           = FALSE,
      	boxsizeoverride   = TRUE,
      	boxparm.stderr    = 1)

# add titles above forest (may be left empty, change labels="" to what you will)

# Draw segment -- 
segments(
  x0  = 0,
  x1  = 94,
  y0  = 98.4,
  y1  = 98.4,
  lwd = 1.3,
  xpd = FALSE)
 
#Outcome label --
text(x      = 0, 
     y      = 117, 
     labels = outcomeLabs[cc], 
     col    = "black",
     adj    = c(0,0), 
     font   = 2, 
     cex    = 1.1)

# left hand column of labels
text(x=0, y=100, labels="Endpoints\n", adj=c(0,0), font=2, cex=1)
text(x=0, y=locs[[cc]]$YLocs, adj=0, cex=1, font=ifelse(forest[[cc]]$IsDiamond, 2,1), labels=left.labels[-blank.rows])
text(x=0, y=locs[[cc]]$BlankLocs, adj=0, font=2, cex=1, labels=left.labels[blank.rows])

# adding other columns for HF and PHD ---

for (jj in seq_along(other.cols)) {
  
  text(x=other.column.xpos[jj], y=105.5, adj=c(0,0), font=2, cex=1, labels=convertUnicode(other.cols.labels[jj]))
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$YLocs,
       font   = ifelse(forest[[cc]]$IsDiamond, 2, 1),
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(merged_forest[[cc]][,other.cols[jj]]))[-blank.rows])
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$BlankLocs,
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(merged_forest[[cc]][,other.cols[jj]]))[blank.rows])
  }

}
  
# stop writing to file
closeFile(type)

```

### DSO versus Rastelli 

```{r}

# Get and bind data for anatomic and physio only
dso_rastelli <- map(
  .x=summary_forest, 
  ~flatten_df(.x) %>% mutate(n_event=paste0(n, "/", N)) %>% 
    filter(surgery%in%c("DSO", "Rastelli"))) 

dso_rastelli <- map(
  .x = dso_rastelli, 
  ~add_table_header(
    data=.x, 
    group_var=surgery, 
    group_level_var=time, 
    extra_space=FALSE) %>%
    select(-Endpoint) %>%
    dplyr::mutate(
      IsDiamond=ifelse(!is.na(incidence), 0, incidence), 
      FillColour=ifelse(!is.na(incidence)==TRUE, 1, incidence)) %>% 
    rename(Heading=time) %>% 
    as.data.frame(.)
  )

# set up an object that stores the forest and associated metadata
forest <- map2(
    .x=dso_rastelli, 
    .y=seq_along(dso_rastelli), 
    ~FormatForest(
      rawdata=rename(.x,
                     !!paste0("IsDiamond", .y):=IsDiamond,
                     !!paste0("FillColour", .y):=FillColour),
    forest.n    = .y,
    EstimateCol = "incidence",
    LCICol      = "LCI",
    UCICol      = "UCI",
    logData     = FALSE,
    getBlanks   = TRUE)
  )


blank.rows  <- forest[[1]]$blank.rows 

# Format headings to incorporate expressions ------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(dso_rastelli[[1]]$Heading))

# what other columns should be plotted
other.cols  <- c("n_studies", "n_event", "I2", "tau2", "phet")
other.cols.labels <- c("Studies", "n/N", "I\U00B2", "Tau\U00B2", "P(Het)")

# find column headings
print.headings <- parseColHeadings(dso_rastelli[[1]]$ColHeadings, rd=dso_rastelli[[1]])


# Make forest plot --

type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage=2,
        type            = type, 
        filestem        = "Sensitivity/Figure - DSO versus Rastelli", 
        page_dpi        = 300,
        page_pointsize  = 15,
        page_height     = 9.5,
        page_width      = 9.5,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.06, 
        footerspace     = 0.01, 
        footer.cex      = 1.6, 
        footer          = "\nn = Number of events; N = Sample size; Het = heterogeneity
        \n " 
        )


# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 3.14537797266251, 1))

mainfont <- 1.1
# blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

# Make forest plot -- 
n_forest   <- length(forest) 

# Plot setting --
spacing    <- 0
plot.width <- 25

# plot labels -- 
xaxmin=33
xaxmax=xaxmin + plot.width

#x position for other headings 
other.column.xpos <- c(xaxmin-16, xaxmin-8, xaxmax+16, xaxmax+23, xaxmax+30) 
outcomeLabs <- c("A. Mortality", "B. Reintervention")

# Draw forest plot -- 
locs <- list()

for (cc in seq_along(forest)) {

  blankPlot(c(0,100),c(0,100), mainfont)
  
  locs[[cc]] <- 
    ForestBasic(
        forest[[cc]],
      	LogScale          = FALSE,
      	ExponentiateDataOnPlot=FALSE,
      	xaxmin            = xaxmin,
      	xaxmax            = xaxmax,
      	xlim              = c(-5, 45), 
      	xticks            = seq(0, 40, 10),
        xticks.ticklength = 0.25,
      	xlab              = c("", "Incidence (%)")[cc],
      	NLabel            = FALSE,
      	mainfont          = 1,
      	ValueLabels       = TRUE,
      	ValueLabelsHeader = "Incidence (95% CI)\n",
      	ValueDigits       = 1,
      	lwd               = 1,
      	CISecond          = TRUE,
      	separator         = " - ",
      	spacing           = spacing,
      	pointGroupsFactor = 0.9,
      	verbose           = FALSE,
      	boxsizeoverride   = TRUE,
      	boxparm.stderr    = 1)

# add titles above forest (may be left empty, change labels="" to what you will)

# Draw segment -- 
segments(
  x0  = 0,
  x1  = 94,
  y0  = 98.4,
  y1  = 98.4,
  lwd = 1.3,
  xpd = FALSE)
 
#Outcome label --
text(x      = 0, 
     y      = 117, 
     labels = outcomeLabs[cc], 
     col    = "black",
     adj    = c(0,0), 
     font   = 2, 
     cex    = 1.1)

# left hand column of labels
text(x=0, y=100, labels="Endpoints\n", adj=c(0,0), font=2, cex=1)
text(x=0, y=locs[[cc]]$YLocs, adj=0, cex=1, font=ifelse(forest[[cc]]$IsDiamond, 2,1), labels=left.labels[-blank.rows])
text(x=0, y=locs[[cc]]$BlankLocs, adj=0, font=2, cex=1, labels=left.labels[blank.rows])

# adding other columns for HF and PHD ---

for (jj in seq_along(other.cols)) {
  
  text(x=other.column.xpos[jj], y=105.5, adj=c(0,0), font=2, cex=1, labels=convertUnicode(other.cols.labels[jj]))
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$YLocs,
       font   = ifelse(forest[[cc]]$IsDiamond, 2, 1),
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(dso_rastelli[[cc]][,other.cols[jj]]))[-blank.rows])
  
  text(x      = other.column.xpos[jj],
       y      = locs[[cc]]$BlankLocs,
       adj    = 0,
       cex    = 1,
       labels = convertUnicode(as.character(dso_rastelli[[cc]][,other.cols[jj]]))[blank.rows])
  }

}
  
# stop writing to file
closeFile(type)

```


